services:
  lpa-dashboard:
    image: 311462405659.dkr.ecr.eu-west-1.amazonaws.com/sirius/sirius-lpa-dashboard:latest
    build:
      dockerfile: docker/sirius-lpa-dashboard/Dockerfile
    depends_on:
      - sirius-mock
    ports: ["8888:8888"]
    environment:
      PORT: 8888
      HEALTHCHECK: /lpa/dashboard/health-check
      SIRIUS_URL: http://sirius-mock:8080
      SIRIUS_PUBLIC_URL: http://localhost:8080

  sirius-mock:
    image: wiremock/wiremock:3.13.2@sha256:27c4b74404f58ceedc6899f73abdfe228d8f80d5efa4d8bd42d6c155558b677c
    ports: ["8563:8080"]
    volumes:
      - "./cypress/mocks:/home/wiremock/mappings"

  puppeteer:
    build: docker/puppeteer
    depends_on:
      - lpa-dashboard
    environment:
      - LHCI_BUILD_CONTEXT__CURRENT_HASH=$GITHUB_SHA
      - LHCI_BUILD_CONTEXT__GITHUB_REPO_SLUG=ministryofjustice/opg-sirius-lpa-dashboard
      - LHCI_GITHUB_APP_TOKEN

  go-lint:
    image: golangci/golangci-lint:v2.8.0@sha256:bebcfa63db7df53e417845ed61e4540519cf74fcba22793cdd174b3415a9e4e2
    working_dir: /go/src/app
    volumes:
      - ./:/go/src/app
      - ./.cache/golangci-lint/v1.53.3:/root/.cache
    command: golangci-lint run -v --timeout 5m --enable gosec --output.text.path stdout --output.sarif.path test-results/golangci-lint.sarif

  test-runner:
    build:
      context: docker/test-runner/
    command: gotestsum --junitfile test-results/unit-tests.xml -- ./... -coverprofile=test-results/test-coverage.txt
    working_dir: /go/src/app
    volumes:
      - ./:/go/src/app
      - ./.gocache:/go/pkg/mod

  pact:
    image: pactfoundation/pact-cli:1@sha256:2bac6b611119eb8444b2fc8b7504e8389222386f5ecefb7307b8ba99f5c6223d
    working_dir: /go/src/app
    volumes:
      - ./pacts:/go/src/app/pacts

  cypress:
    image: cypress/included:15.9.0@sha256:91111352c3adf4a0ff5bee6f3f49af56a66deb81d74a784dbb68bc98a3fbd26e
    command: run --browser chrome
    entrypoint: cypress
    depends_on:
      - lpa-dashboard
      - sirius-mock
    environment:
      - CYPRESS_BASE_URL=http://lpa-dashboard:8888
      - CYPRESS_MOCK_SERVER_URI=http://sirius-mock:8080
      - CYPRESS_VIDEO=false
    working_dir: /e2e
    volumes:
      - ./:/e2e

  trivy:
    image: aquasec/trivy:latest@sha256:1c78ed1ef824ab8bb05b04359d186e4c1229d0b3e67005faacb54a7d71974f73
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.trivy-cache:/root/.cache
      - ./test-results:/test-results
